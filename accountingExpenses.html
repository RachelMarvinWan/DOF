<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="au theme template">
    <meta name="author" content="Hau Nguyen">
    <meta name="keywords" content="au theme template">

    <!-- Title Page-->
    <title>DOF - Accounting - Expenses</title>

    <!-- Fontfaces CSS-->
    <link href="css/font-face.css" rel="stylesheet" media="all">
    <link href="vendor/font-awesome-4.7/css/font-awesome.min.css" rel="stylesheet" media="all">
    <link href="vendor/font-awesome-5/css/fontawesome-all.min.css" rel="stylesheet" media="all">
    <link href="vendor/mdi-font/css/material-design-iconic-font.min.css" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href="vendor/bootstrap-4.1/bootstrap.min.css" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href="vendor/animsition/animsition.min.css" rel="stylesheet" media="all">
    <link href="vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet" media="all">
    <link href="vendor/wow/animate.css" rel="stylesheet" media="all">
    <link href="vendor/css-hamburgers/hamburgers.min.css" rel="stylesheet" media="all">
    <link href="vendor/slick/slick.css" rel="stylesheet" media="all">
    <link href="vendor/select2/select2.min.css" rel="stylesheet" media="all">
    <link href="vendor/perfect-scrollbar/perfect-scrollbar.css" rel="stylesheet" media="all">
    <link href="vendor/vector-map/jqvmap.min.css" rel="stylesheet" media="all">

    <!-- DataTables -->
    <link rel="stylesheet" href="vendor/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="vendor/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="vendor/datatables-buttons/css/buttons.bootstrap4.min.css">

    <!-- Date Range Picker CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <!-- Main CSS-->
    <link href="css/theme.css" rel="stylesheet" media="all">

    <style>
    </style>
</head>

<body>
    <div class="page-wrapper">
        <!-- HEADER MOBILE-->
        <header class="header-mobile d-block d-lg-none">
            <div class="header-mobile__bar">
                <div class="container-fluid">
                    <div class="header-mobile-inner">
                        <a class="logo" href="/Telemetry">
                            <img src="images/SBDLogo.jpeg" alt="Satok Bridge Digital" />
                        </a>
                        <button class="hamburger hamburger--slider" type="button">
                            <span class="hamburger-box">
                                <span class="hamburger-inner"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="navbar-mobile">
                <div class="container-fluid">
                    <ul class="navbar-mobile__list list-unstyled">
                        <li>
                            <a href="/Telemetry">
                                <i class="fas fa-tachometer-alt"></i><span data-i18n="telemetry"></span></a>
                        </li>
                        <li>
                            <a href="/History">
                                <i class="fas fa-archive"></i><span data-i18n="history"></span></a>
                        </li>
                        <li class="has-sub">
                            <a class="js-arrow" href="#">
                                <i class="fas fa-chart-bar"></i><span data-i18n="accounting"></span>
                            </a>
                            <ul class="navbar-mobile-sub__list list-unstyled js-sub-list">
                                <li>
                                    <a href="/Accounting-Expenses"><span data-i18n="expenses"></a>
                                </li>
                                <li>
                                    <a href="Accounting-Income"><span data-i18n="income"></a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="/Gallery">
                                <i class="fas fa-table"></i><span data-i18n="gallery"></span></a>
                        </li>
                        <li>
                            <a href="/About">
                                <i class="far fa-users"></i><span data-i18n="about"></span></a>
                        </li>
                        <li>
                            <a href="/Settings">
                                <i class="fas fa-wrench"></i><span data-i18n="settings"></span></a>
                        </li>
                        <br>
                        <li>
                            <center>
                                <button id="logoutBtn" class="au-btn au-btn--logout au-btn-icon">
                                    <i class="zmdi zmdi-power"></i><span data-i18n="logout"></span>
                                </button>
                            </center>
                        </li>
                        <br>
                    </ul>
                </div>
            </div>
        </header>
        <!-- END HEADER MOBILE-->
  
        <!-- MENU SIDEBAR-->
        <aside class="menu-sidebar d-none d-lg-block">
            <div class="logo">
                <a href="#">
                    <img src="images/SBDLogo.jpeg" alt="Satok Bridge Digital" />
                </a>
            </div>
            <div class="menu-sidebar__content js-scrollbar1">
                <nav class="navbar-sidebar">
                    <ul class="list-unstyled navbar__list">
                        <li>
                            <a href="/Telemetry">
                                <i class="fas fa-tachometer-alt"></i><span data-i18n="telemetry"></span></a>
                        </li>
                        <li>
                            <a href="/History">
                                <i class="fas fa-archive"></i><span data-i18n="history"></span></a>
                        </li>
                        <li class="active has-sub">
                            <a class="js-arrow" href="#">
                                <i class="fas fa-chart-bar"></i><span data-i18n="accounting"></span>
                            </a>
                            <ul class="list-unstyled navbar__sub-list js-sub-list">
                                <li>
                                    <a href="/Accounting-Expenses"><span data-i18n="expenses"></a>
                                </li>
                                <li>
                                    <a href="/Accounting-Income"><span data-i18n="income"></a>
                                </li>
                            </ul>
                        </li>
                        <li>
                            <a href="/Gallery">
                                <i class="fas fa-table"></i><span data-i18n="gallery"></span></a>
                        </li>
                        <li>
                            <a href="/About">
                                <i class="far fa-users"></i><span data-i18n="about"></span></a>
                        </li>
                        <li>
                            <a href="/Settings">
                                <i class="fas fa-wrench"></i><span data-i18n="settings"></span></a>
                        </li>
                        <br>
                        <li>
                            <center>
                                <button id="logoutBtn" class="au-btn au-btn--logout au-btn-icon">
                                    <i class="zmdi zmdi-power"></i><span data-i18n="logout"></span>
                                </button>
                            </center>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <!-- END MENU SIDEBAR-->

        <!-- PAGE CONTAINER-->
        <div class="page-container">
            <!-- MAIN CONTENT -->
            <div class="main-content">
                <div class="section__content section__content--p30">
                    <div class="container-fluid">
                      <div class="row">
                        <div class="col">
                          <center><h1 class="m-4"><span data-i18n="accounting"></span> - <span data-i18n="expenses"></span></h1></center>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col d-flex justify-content-end">
                          <button class="au-btn align-items-center m-r-10" onclick="window.location.href='/Add-New-Expense';">
                            <span data-i18n="addExpRec"></span>
                          </button>
                        </div>
                      </div><br>
                      <div class="row">
                        <div class="col">
                          <div class="au-card">
                            <div class="au-card-header">
                              <div class="row">
                                <div class="col justify-content-start"><h3><span data-i18n="expsRec"></span></h3></div>
                                <div class="col d-flex justify-content-end">
                                  <div class="form-group">
                                    <select id="category-filter" class="form-control select2" style="width: 100%;">
                                      <option value="">All Categories</option>
                                      <option>Aquaculture Equipment</option>
                                      <option>Chemicals and Medications</option>
                                      <option>Feed Costs</option>
                                      <option>Fertilizers and Lime</option>
                                      <option>Purchase of Livestock</option>
                                      <option>Repairs and Maintenance</option>
                                      <option>Storage and Warehousing</option>
                                      <option>Other Expense</option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </div><br>
                                <table id="expense-table" class="table table-bordered table-striped">
                                  <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Expense Item</th>
                                        <th>Category</th>
                                        <th>Remarks</th>
                                        <th>View Record</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      <tr>
                                        <td>30/01/2024</td>
                                        <td>$120</td>
                                        <td>Fingerling feed</td>
                                        <td>Feed Costs</td>
                                        <td>-</td>
                                        <td><a href="/View-Expense-Record">View</a></td>
                                      </tr>
                                      <tr>
                                        <td>21/12/2024</td>
                                        <td>$150</td>
                                        <td>Net</td>
                                        <td>Repairs and Maintenance</td>
                                        <td>-</td>
                                        <td><a href="/View-Expense-Record">View</a></td>
                                      </tr>
                                  </tbody>
                                </table>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col">
                          <!-- BAR CHART -->
                          <div class="au-card">
                            <div class="au-card-header">
                              <h3><span data-i18n="expAnalysis"></span></h3><br>
                            </div>
                            <div class="au-card-body">
                              <div class="row justify-content-between align-items-center">
                                <button type="button" class="btn btn-primary" id="prevYear" style="left: 10px;">
                                  <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" class="btn btn-primary" id="nextYear" style="right: 10px;">
                                  <i class="fas fa-arrow-right"></i>
                                </button>
                              </div>
                              <div class="chart">
                                <canvas id="barChart" style="min-height: 250px; height: 400px; max-height: 400px; max-width: 100%;"></canvas>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col">
                          <div class="au-card">
                            <div class="au-card-header">
                              <h3><span data-i18n="expCategoryAnalysis"></span></h3><br>
                            </div>
                            <div class="au-card-body">
                              <div class="row justify-content-between align-items-center">
                                <button type="button" class="btn btn-primary" id="prevYearPie">
                                  <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="button" class="btn btn-primary" id="nextYearPie">
                                  <i class="fas fa-arrow-right"></i>
                                </button>
                              </div>
                              <div class="chart">
                                <canvas id="pieChart" style="min-height: 250px; height: 400px; max-height: 400px; max-width: 100%;"></canvas>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="row p-t-40"></div>
                    </div>
                </div>
            </div>
            <!-- END MAIN CONTENT-->
            <!-- END PAGE CONTAINER-->
        </div>

    </div>

    <!-- Jquery JS-->
    <script src="vendor/jquery-3.2.1.min.js"></script>
    <!-- Bootstrap JS-->
    <script src="vendor/bootstrap-4.1/popper.min.js"></script>
    <script src="vendor/bootstrap-4.1/bootstrap.min.js"></script>
    <!-- Vendor JS -->
    <script src="vendor/slick/slick.min.js"></script>
    <script src="vendor/wow/wow.min.js"></script>
    <script src="vendor/animsition/animsition.min.js"></script>
    <script src="vendor/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
    <script src="vendor/counter-up/jquery.waypoints.min.js"></script>
    <script src="vendor/counter-up/jquery.counterup.min.js"> </script>
    <script src="vendor/circle-progress/circle-progress.min.js"></script>
    <script src="vendor/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="vendor/chartjs/Chart.bundle.min.js"></script>
    <script src="vendor/select2/select2.min.js"></script>

    <!-- DataTables  & Plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="vendor/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="vendor/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="vendor/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="vendor/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="vendor/jszip/jszip.min.js"></script>
    <script src="vendor/pdfmake/pdfmake.min.js"></script>
    <script src="vendor/pdfmake/vfs_fonts.js"></script>
    <script src="vendor/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="vendor/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="vendor/datatables-buttons/js/buttons.colVis.min.js"></script>

    <!-- Main JS-->
    <script src="js/main.js"></script>

    <!--   History Page JS   -->
    <script src="js/history.js"></script>

    <!-- User Account JS -->
    <script src="js/userAccount.js"></script>

    <!-- Date Range Picker JS -->
    <script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <!-- Language Switch JS -->
    <script src="js/language_switch.js"></script>

<!-- Data Table Script -->
<script>
    $(function () {
      $("#expense-table").DataTable({
        "responsive": true, "lengthChange": false, "autoWidth": false, "searching": true,
        "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
      }).buttons().container().appendTo('#expense-table_wrapper .col-md-6:eq(0)');
    });
  </script>

<script>
  $(document).ready(function() {
      // Check if DataTable is already initialized
      if (!$.fn.DataTable.isDataTable('#expense-table')) {
          // Initialize DataTable with sorting on the Date column (index 0)
          var table = $('#expense-table').DataTable({
              "order": [[0, "desc"]],
              "columnDefs": [
                  {
                      "targets": 0,
                      "type": "date-eu"
                  }
              ]
          });

          // Filter table based on category selection
          $('#category-filter').on('change', function() {
              var selectedCategory = $(this).val();
              if (selectedCategory) {
                  table.column(3).search('^' + selectedCategory + '$', true, false).draw();
              } else {
                  table.column(3).search('').draw();
              }
          });
      }
  });

  // Custom date sorting (European format dd/mm/yyyy)
  $.fn.dataTable.ext.type.order['date-eu-pre'] = function(d) {
      var parts = d.split('/');
      return Date.parse(parts[2] + '-' + parts[1] + '-' + parts[0]);
  };

</script>

<!-- Page specific script -->
<script>
  $(function () {
    //Initialize Select2 Elements
    $('.select2').select2()

    //Initialize Select2 Elements
    $('.select2bs4').select2({
      theme: 'bootstrap4'
    })

  })
</script>

<!-- Bar Chart Script -->
<script>
$(function () {
    const ctx = $('#barChart').get(0).getContext('2d');
    let currentYear = new Date().getFullYear();

    const parseExpenseTable = () => {
        const data = {};
        // Parse all rows, not just the displayed ones
        $('#expense-table').DataTable().rows().every(function () {
            const row = $(this.node());
            const amount = parseFloat(row.find('td').eq(1).text().replace('$', '').trim());
            const date = row.find('td').eq(0).text().trim();  // Updated index for date column
            const [day, month, year] = date.split('/').map(Number);

            if (!data[year]) data[year] = Array(12).fill(0);
            data[year][month - 1] += amount;
        });
        return data;
    };

    const expenseData = parseExpenseTable();

    const updateChart = (year) => {
        if (!expenseData[year]) {
            alert(`No data available for ${year}`);
            return;
        }

        const barChartData = {
            labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            datasets: [{
                label: `Expenses in ${year}`,
                backgroundColor: 'rgba(60,141,188,0.9)',
                borderColor: 'rgba(60,141,188,0.8)',
                data: expenseData[year]
            }]
        };

        if (window.myBarChart) {
            window.myBarChart.destroy();
        }

        window.myBarChart = new Chart(ctx, {
            type: 'bar',
            data: barChartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                title: {
                    display: true,
                    text: `Expenses for ${year}`,
                    fontSize: 18,
                    fontColor: '#333'
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        fontSize: 12,
                        fontColor: '#666'
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 1000 // Fixed y-axis maximum value
                        }
                    }]
                }
            }
        });
    };

    $('#prevYear').click(() => {
        currentYear--;
        updateChart(currentYear);
    });

    $('#nextYear').click(() => {
        currentYear++;
        updateChart(currentYear);
    });

    updateChart(currentYear);  // Initialize with the current year data
});

</script>

<!-- Pie Chart Script -->
<script>
$(function () {
    const ctxPie = $('#pieChart').get(0).getContext('2d');
    let currentYear = new Date().getFullYear();

    const parseExpenseTable = () => {
        const data = {};

        // Parse all rows, not just the displayed ones
        $('#expense-table').DataTable().rows().every(function () {
            const row = $(this.node());
            const amount = parseFloat(row.find('td').eq(1).text().replace('$', '').trim());
            const date = row.find('td').eq(0).text().trim();  // Updated index for date column
            const category = row.find('td').eq(3).text().trim();  // Updated index for category column
            const [day, month, year] = date.split('/').map(Number);

            if (!data[year]) data[year] = {};
            if (!data[year][category]) data[year][category] = 0;
            data[year][category] += amount;
        });
        return data;
    };

    const expenseData = parseExpenseTable();

    const getYearlyPieData = (year) => {
        const yearlyData = expenseData[year];
        if (!yearlyData) {
            alert(`No data available for ${year}`);
            return null;
        }

        const categories = Object.keys(yearlyData);
        const amounts = categories.map(cat => yearlyData[cat]);

        const pieChartData = {
            labels: categories,
            datasets: [{
                backgroundColor: [
                    '#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc',
                    '#d2d6de', '#8a6d3b', '#605ca8', '#78c2ad', '#b66353'
                ],  // Colors for each category
                data: amounts
            }]
        };

        return pieChartData;
    };

    const updatePieChart = (year) => {
        const pieData = getYearlyPieData(year);

        if (!pieData) return;

        if (window.myPieChart) {
            window.myPieChart.destroy();
        }

        window.myPieChart = new Chart(ctxPie, {
            type: 'pie',
            data: pieData,
            options: {
                maintainAspectRatio: false,
                responsive: true,
                title: {
                    display: true,
                    text: `Expenses Categories for ${year}`,
                    fontSize: 18,
                    fontColor: '#333'
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        fontSize: 12,
                        fontColor: '#666'
                    }
                }
            }
        });
    };

    $('#prevYearPie').click(() => {
        currentYear--;
        updatePieChart(currentYear);
    });

    $('#nextYearPie').click(() => {
        currentYear++;
        updatePieChart(currentYear);
    });

    // Initial load with current year data
    updatePieChart(currentYear);
});

</script>

</body>
</html>
